{% extends "../base.html" %}

{% block add %}
<!--警告框-->

    <div id="myAlert" class="alert alert-warning" style="display: none">
	    <a href="#" class="close" data-dismiss="alert">&times;</a>
	    <strong>警告！</strong>编辑时只能勾选一条!
    </div>
    <div id="myAlert1" class="alert alert-warning" style="display: none">
	    <a href="#" class="close" data-dismiss="alert">&times;</a>
	    <strong>警告！</strong>删除时一定要勾选一条!
    </div>

<!--按钮-->
<div class="btn-toolbar" role="toolbar">
  <div class="btn-group" style="padding-top: 20px;left: 50px">
    <button id="add_step" class="btn btn-primary " data-toggle="modal" data-target="#addmyModal">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> 添加接口用例步骤
    </button>

    <button id="btn2" class="btn btn-primary"  data-toggle="modal" data-target="#">
        <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>修改
    </button>
      <button id="del_step" type="onclick" class="btn btn-danger ">
            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> 删除
        </button>
    <!--<form id="del_btn" method="POST" action="/del_project/" style="display: inline;">
        <input id="ipt1" type="text" name="pid" style="display: none"/>
         <button id="btn_delete" type="onclick" class="btn btn-danger ">
            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> 删除
        </button>
        {% csrf_token %}
    </form>-->

  </div>

</div>

<!--步骤列表-->
<div class="container">
        <div class="row">
            <div class="col-md-12">

                <table id= "table" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>选中</th>
                            <th>id</th>
                            <th>步骤名称</th>
                            <th>用例名称</th>
                            <th>请求方式</th>
                            <th>消息头</th>
                            <th>请求参数</th>
                            <th>请求文件</th>
                            <th>断言</th>
                            <th style="display:None">接口依赖</th>
                            <th>优先级</th>
                            <th>步骤描述</th>
                            <th>状态</th>

                        </tr>
                    </thead>
                    <tbody>
                        {% for step_obj in api_list %}

                                <tr>
                                    <td id="che1"><input type="checkbox"/></td>
                                    <td>{{ step_obj.api_id}}</td>
                                    <td>{{ step_obj.step_name }}</td>
                                    <td>{{ step_obj.case }}</td>
                                    <td>{{ step_obj.method }}</td>
                                    <td>{{ step_obj.headers }}</td>
                                    <td>{{ step_obj.params }}</td>
                                    <td>{{ step_obj.files }}</td>
                                    <td>{{ step_obj.assert_response }}</td>
                                    <td style="display:None">{{ step_obj.api_dependency }}</td>
                                    <td>{{ step_obj.step_level }}</td>
                                    <td>{{ step_obj.step_desc }}</td>
                                    <td>{{ step_obj.status }}</td>


                                </tr>

                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!-- 新增项目模态框 -->
    <div class="modal fade" id="addmyModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">添加用例步骤</h4>
          </div>
          <div class="modal-body">
              <form role="form">
                  {% csrf_token %}
                  <div class="form-group">
                    <label for="step_name">步骤名称</label>
                    <input type="text" name="step_name" id="step_name" class="ipt form-control" placeholder="输入步骤名称">
                  </div>
                  <h6 style="color: red"><span class="error"></span></h6>
                  <div class="form-group">
                    <label for="case_id">用例名称</label>

                        <select name="case_id" id="case_id" class="form-control">
                            {% for case_obj in case_list %}
                            <option value="{{case_obj.pk}}">{{case_obj.case_name}}</option>
                            {% endfor %}
                        </select>

                  </div>
                  <div class="form-group">
                    <label >请求方式</label>
                      <br>
                      <div class="btn-group">
                          <button id="add_get" type="button" name="method" class="btn btn-primary">get</button>
                          <button id="add_post_form" type="button" name="method" class="btn btn-primary">post_form</button>
                          <button id="add_post_body" type="button" name="method" class="btn btn-primary">post_body</button>
                          <button id="add_post_file" type="button" name="method" class="btn btn-primary">post_file</button>
                          <input id="method" type="text" name="method" style="display:None" required/>
                      </div>

                  </div>
                  <div class="form-group">
                    <label for="headers">消息头</label>
                      <ul id="add_headers_ul" style="list-style-type:none">
                          <li>
                              <input id="ipt10" class="add_headers" type="text" placeholder="名称" />&nbsp;&nbsp;&nbsp;&nbsp;<input class="add_headers" type="text" placeholder="值" />
                              <input id="add_headers" type="button" class="btn btn-primary" style="height:24px;width:24px;text-align:center;margin:0px;padding:0px;" value="+">
                              <input id="del_headers" type="button" class="btn btn-primary" style="height:24px;width:24px;text-align:center;margin:0px;padding:0px;" value="-">
                              <input id="add_merge_headers" type="text" style="display:None" name="headers">
                          </li>
                      </ul>

                  </div>
                  <div class="form-group" id="add_params_div">
                    <label for="params">请求参数</label>
                      <ul id="add_params_ul" style="list-style-type:none">
                          <li>
                              <input class="add_params" type="text" placeholder="参数名" />&nbsp;&nbsp;&nbsp;&nbsp;<input class="add_params" type="text" placeholder="参数值" />
                              <input id="add_params" type="button" class="btn btn-primary" style="height:24px;width:24px;text-align:center;margin:0px;padding:0px;" value="+">
                              <input id="del_params" type="button" class="btn btn-primary" style="height:24px;width:24px;text-align:center;margin:0px;padding:0px;" value="-">
                              <input id="add_merge_params" type="text" style="display:None" name="params">
                          </li>
                      </ul>

                  </div>
                  <div class="form-group" id="add_params_body_div">
                    <label for="params_body">请求参数body</label>
                      <textarea class="form-control" name="params_body" cols="60" rows="5" id="params_body" ></textarea>
                  </div>
                  <div class="form-group" id="add_files_div">
                      <label for="files">文件上传</label>
                      <ul id="add_files_ul" style="list-style-type:none">
                          <li>
                              <input type="text" placeholder="文件名称" />&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" placeholder="参数名称"/>&nbsp;&nbsp;&nbsp;&nbsp;<input type="text" placeholder="MiME类型" style="width:70px">
                              <input id="add_files" type="button" class="btn btn-primary" style="height:24px;width:24px;text-align:center;margin:0px;padding:0px;" value="+">
                              <input id="del_files" type="button" class="btn btn-primary" style="height:24px;width:24px;text-align:center;margin:0px;padding:0px;" value="-">
                          </li>
                      </ul>
                  </div>

                  <div class="form-group">
                      <label for="asserts">断言</label>
                      <div id="add_div_big" class="add_open_big">
                          <div id="add_div_small" class="add_open_small"></div>
                      </div>
                      <ul id="add_assert_response_ul" style="list-style-type:none">
                          <li>
                              <input   type="text" class="add_assert" placeholder="断言名" value="['code']" /><select class="add_assert_Way"><option value="assertEqual">等于</option><option value="assertNotEqual">不等于</option><option value="assertRegexpMatches">包含</option><option value="assertNotRegexpMatches">不包含</option><option value="assertGreater">大于</option><option value="assertGreaterEqual">大于等于</option><option value="assertLess">小于</option><option value="assertLessEqual">小于等于</option><option value="assertIn">在列表中</option><option value="assertNotIn">不在列表中</option></select><input   type="text" class="add_assert" placeholder="值" />
                                <input id="add_assert_response" type="button" class="btn btn-primary"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="+">
                                <input id="del_assert_response" type="button" class="btn btn-primary"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="-">
                                <input id="add_merge_asserts" type="text" style="display:None" name="asserts"/>
                          </li>
                      </ul>
                  </div>
                  <div class="form-group">
                      <label for="dependency">接口依赖</label>
                      <div id="add_div_big_api_dependency" class="add_open_big">
                          <div id="add_div_small_api_dependency" class="add_open_small"></div>
                      </div>
                      <ul id="add_api_dependency_ul" style="list-style-type:none">
                          <li>
                              <select class="add_api_dependency_step">{% for step in step_names %}<option>{{ step }}</option>{% endfor %}</select><br/>
                              <input type="text" class="add_api_dependency" placeholder="变量名" />&nbsp;&nbsp;&nbsp;<input type="text" class="add_api_dependency" placeholder="路径" />
                                <input id="add_api_dependency" type="button" class="btn btn-primary"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="+">
                                <input id="del_api_dependency" type="button" class="btn btn-primary"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="-">
                                <input id="add_merge_api_dependency" type="text" style="display:None" name="dependency"/>
                          </li>
                      </ul>
                  </div>
                  <div class="form-group">
                      <label for="step_level">优先级</label>
                      <input type="text" class="form-control" name="step_level" id="step_level" placeholder="请输入优先级">
                  </div>
                  <div class="form-group">
                      <label>用例步骤状态</label>
                      <div>
                          <label class="radio-inline">
                              <input type="radio" name="status" id="optionsRadios1" value="1" checked> 有效

                          </label>
                          &nbsp;&nbsp;&nbsp;&nbsp;
                          <label class="radio-inline">
                              <input type="radio" name="status" id="optionsRadios2" value="0"> 无效
                          </label>
                      </div>

                  </div>
                  <div class="form-group">
                    <label for="step_desc">用例步骤描述</label>
                    <textarea name="step_desc" id="step_desc" cols="60" rows="3" class="form-control" placeholder="输入用例描述"></textarea>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary add_step_sub">提交</button>
                  </div>

              </form>

          </div>

        </div>
      </div>
    </div>


<!-- 编辑 -->
    <div class="modal fade" id="editMyModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	<div class="modal-dialog" style="max-width:560px">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
					&times;
				</button>
				<h4 class="modal-title" id="myModalLabel">
					编辑步骤
				</h4>
			</div>
			<div class="modal-body">
                <form id="edit" role="form" method='POST' action="/step_edit_data/">
                    <div class="form-group" style="display: none">
                        <label  for="id">id</label>
                        <input  type="text" class="ipt form-control" name="id" placeholder="请输入id" >
                    </div>
                    <div class="form-group">
                        <label  for="step_name">步骤名</label>
                        <input  id="editstep_name" type="text" class="ipt form-control" name="step_name" placeholder="请输入步骤名" readonly="readonly" required >
                    </div>
                    <div class="form-group">
                        <label  for="case_name" >用例名</label>
                        <select name="case_name" class="ipt form-control" required>
                            {% for case_name in case_names %}
                            <option>{{ case_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label >方式</label>
                        <br>
                        <div class="btn-group ">
                            <button id="editget" type="button" name="method" class="btn btn-default" >get</button>
                            <button id="editpostform" type="button" name="method" class="btn btn-default">postform</button>
                            <button id="editpostbody" type="button" name="method" class="btn btn-default">postbody</button>
                            <button id="editpostfile" type="button" name="method" class="btn btn-default">postfile</button>
                            <input id="editmethod" name="method" type="text" style="display:None" class="ipt"  required/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="headers" >信息头</label>
                       <ul id="editheadersul" style="list-style-type: none" >
                            <li>
                                <input class="editheaders" type="text"  placeholder="名称"  /><input  class="editheaders" type="text"  placeholder="值" />
                                <input id="addheadersedit" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="+">
                                <input id="delheadersedit" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="-">
                                <input id="editmergeheaders" type="text" style="display:None" class="ipt" name="headers"/>
                            </li>
                       </ul>
                    </div>
                    <div class="form-group" id="editparamsdiv">
                        <label for="params" >Parameters</label>
                       <ul id="editparamsul" style="list-style-type: none" >
                            <li>
                                <input   type="text" class="editparams" placeholder="参数名"  /><input   type="text" class="editparams" placeholder="参数值" />
                                <input id="addparamsedit" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="+">
                                <input id="delparamsedit" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="-">
                                <input id="editmergeparams" type="text" style="display:None" class="ipt" name="params"/>
                            </li>
                       </ul>
                    </div>
                    <div class="form-group" id="editparamsbodydiv">
                        <label for="paramsbody" >Body Data</label>
                        <textarea  class="form-control" name="paramsbody" style="height:150px"></textarea>
                    </div>
                    <div class="form-group" id="editfilesdiv">
                        <label for="files" >Files Upload</label>
                       <ul id="addfilesul" style="list-style-type: none" >
                            <li>
                                <input   type="text"  placeholder="文件名称"  /><input   type="text"  placeholder="参数名称" /><input   type="text"  placeholder="MIME类型" style="width: 70px"/>
                                <input id="addfiles" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="+">
                                <input id="delfiles" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="-">
                                <input id="addmergefiles" type="text" class="ipt" name="files"/>
                            </li>
                       </ul>
                    </div>
                    <div class="form-group">
                        <label for="params" >Assert</label>
                        <div id="editdivbig" class="addopenbig">
                            <div id="editdivsmall" class="addopensmall"></div>
                        </div>

                       <ul id="editassert_responseul" style="list-style-type: none" >
                            <li>
                                <input   type="text" class="editassert" placeholder="断言名" value="['code']" /><select class="editassertWay" ><option value="assertEqual">等于</option><option value="assertNotEqual">不等于</option><option value="assertRegexpMatches">包含</option><option value="assertNotRegexpMatches">不包含</option><option value="assertGreater">大于</option><option value="assertGreaterEqual">大于等于</option><option value="assertLess">小于</option><option value="assertLessEqual">小于等于</option><option value="assertIn">在列表中</option><option value="assertNotIn">不在列表中</option></select><input   type="text" class="editassert" placeholder="值" />
                                <input id="addassert_responseedit" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="+">
                                <input id="delassert_responseedit" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="-">
                                <input id="editmergeasserts" type="text" style="display:None" class="ipt" name="asserts"/>
                            </li>
                       </ul>
                    </div>

                    <div class="form-group">
                        <label for="params" >API Dependency</label>
                        <div id="editdivbigApiDependency" class="addopenbig">
                            <div id="editdivsmallApiDependency" class="addopensmall"></div>
                        </div>

                       <ul id="editApiDependencyul" style="list-style-type: none" >
                            <li>
                                <select class="editApiDependencyStep">{% for step in step_names %}<option>{{ step }}</option>{% endfor %}</select><br/>
                                <input   type="text" class="editApiDependency" placeholder="变量名"  /><input   type="text" class="editApiDependency" placeholder="路径" />
                                <input id="addApiDependencyedit" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="+">
                                <input id="delApiDependencyedit" type="button" class="btn btn-default"  style="height:24px;width:24px;text-align:center; margin:0px; padding:0px;" value="-">
                                <input id="editmergeApiDependencys" type="text" style="display:None" class="ipt" name="ApiDependencys"/>
                            </li>
                       </ul>
                    </div>

                    <div class="form-group">
                        <label  for="steplevel">优先级</label>
                        <input  type="text" class="ipt form-control" name="steplevel" placeholder="请输入优先级" >
                    </div>
                    <div class="form-group">
                        <label for="step_desc">步骤描述</label>
                        <input  type="text" class="ipt form-control" name="step_desc" placeholder="请输入步骤描述">
                    </div>
                    <div class="form-group" >
                        <label class="checkbox-inline">
                            <input type="checkbox" class="ipt" name="status" id="optionsRadios1" checked> 状态
                        </label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn layui-btn" data-dismiss="modal">关闭
				        </button>
				        <button id="editsubmit" type="onclick" class="btn layui-btn">
					    提交
				        </button>
			        </div>
                    {% csrf_token %}
                </form>
			</div>
		</div><!-- /.modal-content -->
	</div><!-- /.modal -->
    </div>

<script>
 // 列表数据超过30个字符，只显示25个字符
    function display() {
        var elements=$("#table").find("td");
        for (var i=0;i<elements.length;i++){
            $(elements[i]).attr("title",$(elements[i]).text());
            if ($(elements[i]).text().length>=30){
                var str=$(elements[i]).text().substring(0,25)+"...";
                $(elements[i]).html(str)

            }
            // 当鼠标在列表上悬停时，出现内容
            $(elements[i]).mouseover(function () {
                $(this).tooltip;

            });
        }

    }
    $(function(){
        edit();
        add();
        //del();
        //paging();
        //search();
        display();
        //funisRepeat();
    });


    // 新增序列增行和减行

    function add_line(add_btn,del_btn,ul_id,placeholder_name,placeholder_value,add_class) {

        $(add_btn).click(function () {
            if(add_class !="add_assert" && add_class !="edit_assert" && add_class !="add_api_dependency_step" && add_class !="edit_api_dependency_step")
            {
                $(ul_id).append("<li><input type=\"text\" class="+add_class+" placeholder=\""+placeholder_name+"\" />&nbsp;&nbsp;&nbsp;&nbsp;<input type=\"text\" class="+add_class+" placeholder=\""+placeholder_value+"\" /></li>")
            }
            // 断言增行
            else if(add_class=="add_assert"){

                 $(ul_id).append("<li><input type=\"text\" class=\""+add_class+"\" placeholder=\""+placeholder_name+"\"  />&nbsp;&nbsp;&nbsp;&nbsp;<select class=\"add_assert_Way\" ><option value=\"assertEqual\">等于</option><option value=\"assertNotEqual\">不等于</option><option value=\"assertRegexpMatches\">包含</option><option value=\"assertNotRegexpMatches\">不包含</option><option value=\"assertGreater\">大于</option><option value=\"assertGreaterEqual\">大于等于</option><option value=\"assertLess\">小于</option><option value=\"assertLessEqual\">小于等于</option><option value=\"assertIn\">在列表中</option><option value=\"assertNotIn\">不在列表中</option></select>&nbsp;&nbsp;&nbsp;&nbsp;<input   type=\"text\" class=\""+add_class+"\" placeholder=\""+placeholder_value+"\" /></li>");
            }
            else if(add_class=="edit_assert"){
                $(ul_id).append("<li><input   type=\"text\" class="+add_class+" placeholder=\""+placeholder_name+"\"  /><select class=\"edit_assert_Way\" ><option value=\"assertEqual\">等于</option><option value=\"assertNotEqual\">不等于</option><option value=\"assertRegexpMatches\">包含</option><option value=\"assertNotRegexpMatches\">不包含</option><option value=\"assertGreater\">大于</option><option value=\"assertGreaterEqual\">大于等于</option><option value=\"assertLess\">小于</option><option value=\"assertLessEqual\">小于等于</option><option value=\"assertIn\">在列表中</option><option value=\"assertNotIn\">不在列表中</option></select><input   type=\"text\" class="+add_class+" placeholder=\""+placeholder_value+"\" /></li>");
            }

            // 接口依赖增行
            else if(add_class=="add_api_dependency"){
                    $(ul_id).append("<li><select class=\"add_api_dependency_step\">{% for step in step_names %}<option>{{ step }} </option>{% endfor %}</select><br/><input   type=\"text\" class="+add_class+" placeholder=\""+placeholder_name+"\"  /><input   type=\"text\" class="+add_class+" placeholder=\""+placeholder_value+"\" /></li>");
            }
            else if(add_class=="edit_api_dependency"){
                $(ul_id).append("<li><select class=\"edit_api_dependency_step\">{% for step in step_names %}<option>{{ step }} </option>{% endfor %}</select><br/><input   type=\"text\" class="+add_class+" placeholder=\""+placeholder_name+"\"  /><input   type=\"text\" class="+add_class+" placeholder=\""+placeholder_value+"\" /></li>");
            }
        });
        $(del_btn).click(function () {
            if($(ul_id+" li").length>1){
                $(ul_id+" li:last").remove();
            }

        });

    }
    // 根据方式控制需要显示的控件
    function control_display(btns,btn,elements,display_list,method) {
        $(btn).click(function () {
            for (var i=0;i<elements.length;i++){
                $(elements[i]).attr("style", display_list[i]);
            }
            // 选中按钮变灰色，其它按钮变回蓝色
            for(var i=0;i<btns.length;i++){
                if(btns[i]==btn){
                    $(btns[i]).attr("class","select_btn btn btn-primary");
                }
                else {
                    $(btns[i]).attr("class","un_select_btn btn btn-default")
                }
            }
            // method的输入框填写方式
            $(method).val($(btn).text());

        });

    }
    function add() {
        // 是否需要断言
        $("#add_div_big").click(function () {
            if ($("#add_div_big").attr("class")=="add_open_big"){
                $("#add_div_big").attr("class", "add_close_big");
                $("#add_div_small").attr("class","add_close_small");
                $("#add_assert_response_ul").attr("style","display:None");
                // 删除断言属性
                $("#add_merge_asserts").removeAttr("name");
            }
            else {
                $("#add_div_big").attr("class","add_open_big");
                $("#add_div_small").attr("class","add_open_small");
                $("#add_assert_response_ul").attr("style","list-style-type:none;display:block");
                // 添加断言属性
                $("#add_merge_asserts").attr("name","asserts");
            }

        });

        //是否要使用接口依赖
            $("#add_div_big_api_dependency").click(function(){
                if ($("#add_div_big_api_dependency").attr("class")=="add_open_big"){
                    $("#add_div_big_api_dependency").attr("class","add_close_big");
                    $("#add_div_small_api_dependency").attr("class","add_close_small");
                    $("#add_api_dependency_ul").attr("style","display:None");
                    //删除断言属性
                    $("#add_merge_api_dependency").removeAttr("name");
                }
                else{
                    $("#add_div_big_api_dependency").attr("class","add_open_big");
                    $("#add_div_small_api_dependency").attr("class","add_open_small");
                    $("#add_api_dependency_ul").attr("style","list-style-type: none;display:block");
                    //添加断言属性
                    $("#add_merge_api_dependency").attr("name","asserts");
                }
            });

        $("#add_step").click(function () {
            $("#myAlert").css("display","none");
            $("#myAlert1").css("display","none");
            // get方式
            $("#add_get").trigger("click");

        });
        // headers增加行和减少行
        var add_btn_headers="#add_headers";
        var del_btn_headers="#del_headers";
        var ul_id_headers="#add_headers_ul";
        var placeholder_name_headers="名称";
        var placeholder_value_headers="值";
        var add_class_headers="add_headers";
        add_line(add_btn_headers,del_btn_headers,ul_id_headers,placeholder_name_headers,placeholder_value_headers,add_class_headers);
        // params增加行和减少行
        var add_btn_params="#add_params";
        var del_btn_params="#del_params";
        var ul_id_params="#add_params_ul";
        var placeholder_name_params="参数名";
        var placeholder_value_params="参数值";
        var add_class_params="add_params";
        add_line(add_btn_params,del_btn_params,ul_id_params,placeholder_name_params,placeholder_value_params,add_class_params);
        //断言增行和减少行
        var add_btn_assert_response="#add_assert_response";
        var del_btn_assert_response="#del_assert_response";
        var ul_id_assert_response="#add_assert_response_ul";
        var placeholder_name_assert_response="断言名";
        var placeholder_value_assert_response="值";
        var add_class_assert="add_assert";
        add_line(add_btn_assert_response,del_btn_assert_response,ul_id_assert_response,placeholder_name_assert_response,placeholder_value_assert_response,add_class_assert);
        //接口依赖增加行
        add_line("#add_api_dependency","#del_api_dependency","#add_api_dependency_ul","变量名","路径","add_api_dependency");
        //文件增行
        $("#add_files").click(function(){
            $("#add_files_ul").append("<li><input   type=\"text\"  placeholder=\"文件名称\"  />&nbsp;&nbsp;&nbsp;&nbsp;<input   type=\"text\"  placeholder=\"参数名称\" />&nbsp;&nbsp;&nbsp;&nbsp;<input   type=\"text\"  placeholder=\"MiME类型\" style=\"width: 70px\"/></li>");
        });
        $("#del_files").click(function(){
                if ($("#add_files_ul li").length>1){
                    $("#add_files_ul li:last").remove();
                }
            });
        // get方式
        var btn="#add_get";
        var elements=["#add_params_div","#add_params_body_div","#add_files_div"];
        var display_list=["display:block","display:None","display:None"];
        var btns=["#add_get","#add_post_form","#add_post_body","#add_post_file"];
        control_display(btns,btn,elements,display_list,"#method");
        //post_form方式
        btn="#add_post_form";

        control_display(btns,btn,elements,display_list,"#method");
        //post_body方式
        btn="#add_post_body";
        elements=["#add_params_div","#add_params_body_div","#add_files_div"];
        display_list=["display:None","display:block","display:None"];
        control_display(btns,btn,elements,display_list,"#method");
        //post_file方式
        btn="#add_post_file";
        elements=["#add_params_div","#add_params_body_div","#add_files_div"];
        display_list=["display:None","display:block","display:None"];
        control_display(btns,btn,elements,display_list,"#method");

        // headers,params和断言数据合并转成json字符串
        function merge_data(btn,select_input) {
            var elements=$(select_input);
            var obj={};
            if(select_input !=".add_assert" && select_input !=".add_api_dependency"){
                for(var i=0;i<elements.length;i+=2){
                    if($(elements[i]).val()){
                        obj[$(elements[i]).val()]=$(elements[i+1]).val();
                    }
                }
            }
            //断言时候数据特殊处理
            else if(select_input==".add_assert"){
                var assert_way_elements=$(".add_assert_Way");
                j=0;
                for (var i=0;i<elements.length;i+=2){
                    if($(elements[i]).val()){
                        var assert_way_obj={};
                        assert_way_obj[$(assert_way_elements[j]).val()]=$(elements[i+1]).val();
                        j+=1;
                        obj[$(elements[i]).val()]=assert_way_obj;
                        alert($(elements[i]).val())
                    }
                }
            }
            else if(select_input==".add_api_dependency"){
                var api_dependency_step_elements=$(".add_api_dependency_step");
                j=0;
                for(var i=0;i<elements.length;i+=2){
                    if($(elements[i]).val()){
                        var api_dependency_step_obj={};
                        api_dependency_step_obj[$(api_dependency_step_elements[j]).val()]=$(elements[i+1]).val();
                        j+=1;
                        obj[$(elements[i]).val()]=api_dependency_step_obj;
                    }
                }
            }
            objstring=JSON.stringify(obj);
            $(btn).val(objstring);



        }
        //提交的时候先把数据合并
            $(".add_step_sub").click(function () {
                //步骤名不能为空
                if($("#step_name").val() !=""){
                    //把信息头的数据合并放到input 的id为add_merge_headers里
                    merge_data("#add_merge_headers",".add_headers");
                    //把参数的数据合并放到input 的id为add_merge_params里
                    merge_data("#add_merge_params",".add_params");
                    //把断言的数据合并放到input 的id为add_merge_asserts里
                    merge_data("#add_merge_asserts", ".add_assert");
                    //把接口依赖的数据合并放到input 的id为add_merge_api_dependency里
                    merge_data("#add_merge_api_dependency",".add_api_dependency");

                    $("#add").submit();


                }
                $.ajax({
                url: "/add_step/",
                type: "post",
                data: {
                    step_name: $("#step_name").val(),
                    case_id: $("#case_id").val(),
                    method: $("#method").val(),
                    headers: $("#add_merge_headers").val(),
                    params: $("#add_merge_params").val(),
                    assert_response: $("#add_merge_asserts").val(),
                    api_dependency: $("#add_merge_api_dependency").val(),
                    step_level: $("#step_level").val(),
                    step_desc: $("#step_desc").val(),
                    params_body: $("#params_body").val(),
                    status: $("*[name='status']:checked").val(),
                    csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                },

                success: function (data) {

                    if (data.status== 0) {
                        // alert(111)
                        toastr.success(data.msg);
                        if (location.search){
                                location.href = location.search.slice(6)
                        }
                        else {
                            setTimeout(function () {
                                location.href = "/api_step/"
                            }, 2000)

                        }

                    }
                    else {


                        $(".error").text(data.msg);
                        setTimeout(function () {
                            $(".error").text("");

                        }, 5000)
                    }



                }

            })


            });


}
//新增
        //序列增行和减行
        function addline(addbtn,delbtn,ulid,placeholdername,placeholdervalue,addclass){
            $(addbtn).click(function(){
                if (addclass!="addassert" && addclass!="editassert" && addclass!="addApiDependency" && addclass!="editApiDependency")
                {
                    $(ulid).append("<li><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdername+"\"  /><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdervalue+"\" /></li>");
                }
                //断言增行特别注意
                else if(addclass=="addassert"){
                    $(ulid).append("<li><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdername+"\"  /><select class=\"addassertWay\" ><option value=\"assertEqual\">等于</option><option value=\"assertNotEqual\">不等于</option><option value=\"assertRegexpMatches\">包含</option><option value=\"assertNotRegexpMatches\">不包含</option><option value=\"assertGreater\">大于</option><option value=\"assertGreaterEqual\">大于等于</option><option value=\"assertLess\">小于</option><option value=\"assertLessEqual\">小于等于</option><option value=\"assertIn\">在列表中</option><option value=\"assertNotIn\">不在列表中</option></select><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdervalue+"\" /></li>");
                }
                else if(addclass=="editassert"){
                    $(ulid).append("<li><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdername+"\"  /><select class=\"editassertWay\" ><option value=\"assertEqual\">等于</option><option value=\"assertNotEqual\">不等于</option><option value=\"assertRegexpMatches\">包含</option><option value=\"assertNotRegexpMatches\">不包含</option><option value=\"assertGreater\">大于</option><option value=\"assertGreaterEqual\">大于等于</option><option value=\"assertLess\">小于</option><option value=\"assertLessEqual\">小于等于</option><option value=\"assertIn\">在列表中</option><option value=\"assertNotIn\">不在列表中</option></select><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdervalue+"\" /></li>");
                }
                //接口依赖增行
                else if(addclass=="addApiDependency"){
                    $(ulid).append("<li><select class=\"addApiDependencyStep\">{% for step in step_names %}<option>{{ step }} </option>{% endfor %}</select><br/><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdername+"\"  /><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdervalue+"\" /></li>");
                }
                else if(addclass=="editApiDependency"){
                    $(ulid).append("<li><select class=\"editApiDependencyStep\">{% for step in step_names %}<option>{{ step }} </option>{% endfor %}</select><br/><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdername+"\"  /><input   type=\"text\" class="+addclass+" placeholder=\""+placeholdervalue+"\" /></li>");
                }
            });
            $(delbtn).click(function(){
                if ($(ulid+" li").length>1){
                    $(ulid+" li:last").remove();
                }
            });
        }

    //根据方式控制需要显示的控件
        function controlDisplay(btns,btn,elements,displaylist,method){
            $(btn).click(function() {
                for (var i = 0; i < elements.length; i++) {
                    $(elements[i]).attr("style", displaylist[i]);
                }
                //选中按钮变灰色,其他按钮变回白色
                for (var i=0;i<btns.length;i++){
                    if (btns[i]==btn){
                        $(btns[i]).attr("class","selectbtn btn btn-default");
                    }
                    else{
                        $(btns[i]).attr("class","unselectbtn btn btn-default");
                    }
                }
                //把method的输入框填写方式
                $(method).val($(btn).text());
            });
        }

    //编辑
        function edit(){
            //编辑控制方式按钮
            //get
            controlDisplay(["#editget","#editpostform","#editpostbody","#editpostfile"],"#editget",["#editparamsdiv","#editparamsbodydiv","#editfilesdiv"],["display:block","display:None","display:None"],"#editmethod");
            //postform
            controlDisplay(["#editget","#editpostform","#editpostbody","#editpostfile"],"#editpostform",["#editparamsdiv","#editparamsbodydiv","#editfilesdiv"],["display:block","display:None","display:None"],"#editmethod");
            //postbody
            controlDisplay(["#editget","#editpostform","#editpostbody","#editpostfile"],"#editpostbody",["#editparamsdiv","#editparamsbodydiv","#editfilesdiv"],["display:None","display:block","display:None"],"#editmethod");
            //postfile
            controlDisplay(["#editget","#editpostform","#editpostbody","#editpostfile"],"#editpostfile",["#editparamsdiv","#editparamsbodydiv","#editfilesdiv"],["display:block","display:None","display:block"],"#editmethod");

            //编辑控制信息头，参数，断言增行和减行
            //信息头
            addline("#addheadersedit","#delheadersedit","#editheadersul","名称","值","editheaders");
            //参数
            addline("#addparamsedit","#delparamsedit","#editparamsul","参数名","参数值","editparams");
            //断言
            addline("#addassert_responseedit","#delassert_responseedit","#editassert_responseul","断言名","值","editassert");
            //接口依赖增行
            addline("#addApiDependencyedit","#delApiDependencyedit","#editApiDependencyul","变量名","路径","editApiDependency");
            //是否要使用断言
            $("#editdivbig").click(function(){
                if ($("#editdivbig").attr("class")=="addopenbig"){
                    $("#editdivbig").attr("class","addclosebig");
                    $("#editdivsmall").attr("class","addclosesmall");
                    $("#editassert_responseul").attr("style","display:None");
                    //删除断言属性
                    $("#editmergeasserts").removeAttr("name");
                }
                else{
                    $("#editdivbig").attr("class","addopenbig");
                    $("#editdivsmall").attr("class","addopensmall");
                    $("#editassert_responseul").attr("style","list-style-type: none;display:block");
                    //添加断言属性
                    $("#editmergeasserts").attr("name","asserts");
                }
            });

            //是否要使用接口依赖
            $("#editdivbigApiDependency").click(function(){
                if ($("#editdivbigApiDependency").attr("class")=="addopenbig"){
                    $("#editdivbigApiDependency").attr("class","addclosebig");
                    $("#editdivsmallApiDependency").attr("class","addclosesmall");
                    $("#editApiDependencyul").attr("style","display:None");
                    //删除断言属性
                    $("#editmergeApiDependencys").removeAttr("name");
                }
                else{
                    $("#editdivbigApiDependency").attr("class","addopenbig");
                    $("#editdivsmallApiDependency").attr("class","addopensmall");
                    $("#editApiDependencyul").attr("style","list-style-type: none;display:block");
                    //添加断言属性
                    $("#editmergeApiDependencys").attr("name","ApiDependencys");
                }
            });

            $("#btn2").click(function(){
                $("#myAlert").css("display","none");
                $("#myAlert1").css("display","none");
                var count=0;
                var env_value;
                var env=new Array();
                var elements=$(".ipt");
                $("#table").find(":checkbox:checked").each(function(){
                    env_value=$(this).parent()
                    for (var i=0;i<elements.length;i++){
                        env_value=env_value.next()
                        //alert(env_value.attr("title"));
                        env[i]=env_value.attr("title");
                    }
                    //alert(plan)
                    count++;
                });
                if (count==1)
                {
                    alert(env);
                    for (var i=0;i<env.length-1;i++){
                        $(elements[i]).val(env[i]);
                    }
                    if (env[env.length-1]=="True"){
                        $(elements[env.length-1]).prop('checked',true);
                    }
                    else{
                        $(elements[env.length-1]).removeAttr('checked');
                    }
                    $('#editMyModal').modal("show");
                }
                else{
                    $("#myAlert").css("display","inherit");
                }
                //点开编辑按钮，method初始化
                var methoddic={"get":"#editget","postform":"#editpostform","postbody":"#editpostbody","postfile":"#editpostfile"}
                $(methoddic[$("#editmethod").val()]).trigger("click");

                //headers,params,assert初始化
                function dellineinit(inputclass,dellinebtn){
                    for (var i=0;i<$(inputclass).length;i++){
                        $(dellinebtn).trigger("click");
                    }
                }
                function editinit(mergebtn,addlinebtn,dellinebtn,inputclass){
                    if ($(mergebtn).val()!=""){
                        var JSONOBJ=JSON.parse($(mergebtn).val());
                        for (var i in JSONOBJ){
                            $(addlinebtn).trigger("click");
                            //alert(JSONOBJ[i]);
                        }
                        $(dellinebtn).trigger("click");
                        //给每行赋值
                        var elements=$(inputclass);
                        var assertwayelements=$(".editassertWay");
                        var ApiDependencyelements=$(".editApiDependencyStep");
                        var j=0;
                        var f=0;
                        if (inputclass!=".editassert" && inputclass!=".editApiDependency"){
                            for (var i in JSONOBJ){
                                $(elements[j]).val(i);
                                $(elements[j+1]).val(JSONOBJ[i]);
                                j+=2;
                            }
                        }
                        //断言特殊处理
                        else if(inputclass==".editassert"){
                            for (var i in JSONOBJ){
                                $(elements[j]).val(i);
                                for (var k in JSONOBJ[i]){
                                    $(elements[j+1]).val(JSONOBJ[i][k]);
                                    //配置断言方式
                                    $(assertwayelements[f]).val(k);
                                }
                                j+=2;
                                f++;
                            }
                        }
                        //接口依赖特殊处理
                        else if(inputclass==".editApiDependency"){
                            for (var i in JSONOBJ){
                                $(elements[j]).val(i);
                                for (var k in JSONOBJ[i]){
                                    $(elements[j+1]).val(JSONOBJ[i][k]);
                                    //配置断言方式
                                    $(ApiDependencyelements[f]).val(k);
                                }
                                j+=2;
                                f++;
                            }
                        }
                    }
                }
                //每次点击修改 先把信息头参数，断言行数归1
                dellineinit(".editheaders","#delheadersedit");
                dellineinit(".editparams","#delparamsedit");
                dellineinit(".editassert","#delassert_responseedit");
                dellineinit(".editApiDependency","#delApiDependencyedit");
                //headers初始化新增行数输入对应的数据
                editinit("#editmergeheaders","#addheadersedit","#delheadersedit",".editheaders");
                //params初始化新增行数输入对应的数据
                editinit("#editmergeparams","#addparamsedit","#delparamsedit",".editparams");
                //assert初始化新增行数输入对应的数据
                editinit("#editmergeasserts","#addassert_responseedit","#delassert_responseedit",".editassert");
                //ApiDependency初始化新增行数输入对应的数据
                editinit("#editmergeApiDependencys","#addApiDependencyedit","#delApiDependencyedit",".editApiDependency");
                //断言开关
                if ($("#editmergeasserts").val()==""){
                    $("#editdivbig").attr("class","addclosebig");
                    $("#editdivsmall").attr("class","addclosesmall");
                    $("#editassert_responseul").attr("style","display:None");
                    //删除断言属性
                    $("#editmergeasserts").removeAttr("name");
                }
                else{
                    $("#editdivbig").attr("class","addopenbig");
                    $("#editdivsmall").attr("class","addopensmall");
                    $("#editassert_responseul").attr("style","list-style-type: none;display:block");
                    //添加断言属性
                    $("#editmergeasserts").attr("name","asserts");
                }

                //接口依赖开关
                if ($("#editmergeApiDependencys").val()==""){
                    $("#editdivbigApiDependency").attr("class","addclosebig");
                    $("#editdivsmallApiDependency").attr("class","addclosesmall");
                    $("#editApiDependencyul").attr("style","display:None");
                    //删除断言属性
                    $("#editmergeApiDependencys").removeAttr("name");
                }
                else{
                    $("#editdivbigApiDependency").attr("class","addopenbig");
                    $("#editdivsmallApiDependency").attr("class","addopensmall");
                    $("#editApiDependencyul").attr("style","list-style-type: none;display:block");
                    //添加断言属性
                    $("#editmergeApiDependencys").attr("name","ApiDependencys");
                }
                //如果是POSTbody得修改参数内容
                if ($("#editmethod").val()=="postbody"){
                    $("#editparamsbodydiv textarea").val($("#editmergeparams").val());
                    $("#editmergeparams").val("");
                    var len=$(".editparams").length;
                    for (var i=0;i<len;i++){
                        if (i==len-1){
                            $(".editparams").each(function(index){
                                $(this).val("");
                            });
                        }
                        else{
                            $("#delparamsedit").trigger("click");
                        }
                    }

                }
                else{
                    $("#editparamsbodydiv textarea").val("");
                }

                //headers，params和断言数据合并转成json字符串
                function mergeData(btn,selectinput){
                    var elements=$(selectinput);
                    var obj={};
                    if (selectinput!=".editassert" && selectinput!=".editApiDependency"){
                        for (var i=0;i<elements.length;i+=2){
                            if($(elements[i]).val()){
                                obj[$(elements[i]).val()]=$(elements[i+1]).val();
                            }
                        }
                    }
                    //断言的时候数据特殊处理
                    else if(selectinput==".editassert"){
                        var assertwayelements=$(".editassertWay");
                        j=0;
                        for (var i=0;i<elements.length;i+=2){
                            if($(elements[i]).val()){
                                var assertwayobj={};
                                assertwayobj[$(assertwayelements[j]).val()]=$(elements[i+1]).val();
                                j+=1;
                                obj[$(elements[i]).val()]=assertwayobj;
                            }
                        }
                    }
                    //接口依赖的时候数据特殊处理
                    else if(selectinput==".editApiDependency"){
                    var ApiDependencyStepelements=$(".editApiDependencyStep");
                    j=0;
                    for (var i=0;i<elements.length;i+=2){
                        if($(elements[i]).val()){
                            var ApiDependencyStepobj={};
                            ApiDependencyStepobj[$(ApiDependencyStepelements[j]).val()]=$(elements[i+1]).val();
                            j+=1;
                            obj[$(elements[i]).val()]=ApiDependencyStepobj;
                        }
                    }
                }
                    objstring=JSON.stringify(obj);
                    $(btn).val(objstring);
                }
                //提交的时候把先把数据合并
                $("#editsubmit").click(function() {
                    //步骤名不为空
                    if ($("#editstep_name").val() != "") {
                        //把信息头的数据合并放到input 的id为editmergeheaders里
                        mergeData("#editmergeheaders", ".editheaders");
                        //把参数的数据合并放到input 的id为editmergeparams里
                        mergeData("#editmergeparams", ".editparams");
                        //把断言的数据合并放到input 的id为editmergeasserts里
                        mergeData("#editmergeasserts", ".editassert");
                        //把接口依赖的数据合并放到input 的id为editmergeasserts里
                        mergeData("#editmergeApiDependencys", ".editApiDependency");
                        $("#edit").submit();
                    }
                });
            });
        }
    //删除用例步骤
     $("#del_step").click(function () {
                var env_ids=new Array();

                    var count=0;

                    var i=0;
                     var row = $(this).parent().parent();
                    var pathname = window.location.pathname;
                    var url = null;
                    $("#table").find(":checkbox:checked").each(function() {

                        env_id = $(this).parent().next().text();

                        if (env_id != "") {

                            env_ids[i++] = env_id;

                        }

                        count++;

                    });

                //alert(count)
                if(count>0){
                    url = /api_step/+env_id+pathname.replace('/api_step/', '/delete/')
                     // 删除插件的应用
                swal({

                    title: "确定要删除吗？",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonClass: "btn-danger",
                    confirmButtonText: "确定",
                    cancelButtonText: "取消",
                    closeOnConfirm: true

                },

                function () {
                    $.ajax({

                        url: url,
                        type: 'post',
                        data:{
                            delete_id: env_id,

                        },

                        success:function (ret) {
                            var data = JSON.parse(ret);
                            if(data.status == 0){
                                row.remove();

                                toastr.success(data.msg);
                                setTimeout(function () {
                                location.href = "/api_step/"
                            }, 2000)


                            }else{
                                toastr.error(data.msg);
                                setTimeout(function () {
                                location.href = "/api_step/"
                            }, 2000)
                            }


                        }
                    });

                });
                }
                else {
                    toastr.error("请至少选择一项")
                }

        });


//编辑模块

        /* $("#edit_step").click(function(){

            var count=0;
            var env_value;
            var plan=new Array();
            var elements=$(".ipt");
            alert(elements.length)
            var url = null;
            $("#table").find(":checkbox:checked").each(function(){
                env_value=$(this).parent()
                for (var i=0;i<elements.length;i++){
                    env_value=env_value.next()

                    plan[i]=env_value.text();


                }
                count++;
            });

            if (count==1)
            {
                alert(plan);
                url = "/api_step/"+plan+"/edit"
                //alert(url)
                for (var i=0;i<plan.length-1;i++){
                    $(elements[i]).val(plan[i]);
                }
                if (plan[plan.length-1]=="True"){
                    $(elements[plan.length-1]).prop('checked',true);
                }
                else{
                    $(elements[plan.length-1]).removeAttr('checked');
                }
                $('#editMyModal').modal("show");
                if(plan>0){
                    location.href = url;
                }
            }
            else if(count==0){
                toastr.error("请至少选择一个选项!")
            }
            else{
                toastr.error("编辑只能选择一个选项!");
            }
        });*/

</script>

{% endblock %}
